# 메타 진행 시스템

**기능 번호**: 018
**브랜치**: `018-meta-progression`
**작성일**: 2025-11-29
**상태**: 명세 완료

---

## 1. 개요

### 1.1 기능 설명
로그라이크 게임의 핵심인 영구 진행(Permanent Progression) 시스템입니다. 플레이어가 던전에서 획득한 메타 재화를 사용하여 영구 업그레이드를 구매하고, 다음 런에서 더 강한 상태로 시작할 수 있습니다. 이를 통해 반복 플레이에 목표와 동기를 부여합니다.

### 1.2 사용자 가치
- **장기 목표 제공**: 여러 런에 걸친 성장 목표
- **실패의 보상**: 죽어도 메타 재화 획득으로 성장
- **점진적 난이도 완화**: 업그레이드로 어려운 스테이지 돌파
- **수집/해금 만족감**: 새로운 폼, 아이템, 능력 해금

### 1.3 범위
- **포함**: 메타 재화, 영구 업그레이드, 해금 시스템, 업적, 로비 UI
- **제외**: 시즌 패스, 일일 퀘스트, 멀티플레이어 랭킹

---

## 2. 사용자 시나리오

### 2.1 주요 시나리오: 런 종료 후 업그레이드

**전제조건**: 플레이어가 던전에서 사망 또는 클리어

**흐름**:
1. 런 결과 화면 표시 (도달 스테이지, 처치 수, 획득 재화)
2. 획득한 메타 재화(Bone, Soul) 확정
3. "로비로 돌아가기" 선택
4. 로비에서 업그레이드 NPC와 상호작용
5. 업그레이드 트리 UI 표시
6. 원하는 업그레이드 선택 및 구매
7. 업그레이드 효과 즉시 적용 (다음 런부터)

### 2.2 시나리오: 폼 해금

**전제조건**: 플레이어가 충분한 Soul 보유

**흐름**:
1. 로비의 폼 해금 NPC 방문
2. 잠긴 폼 목록 확인
3. 해금 조건 확인 (Soul 비용, 선행 조건)
4. 해금 가능한 폼 선택 및 구매
5. 해금 완료 이펙트
6. 다음 런부터 해당 폼 드롭 풀에 추가

### 2.3 시나리오: 업적 달성

**전제조건**: 플레이어가 특정 조건 달성

**흐름**:
1. 업적 조건 충족 시 알림 표시 (던전 내)
2. 런 종료 후 업적 보상 수령
3. 업적 목록에서 완료 상태 확인
4. 일부 업적은 특별 보상 해금 (폼, 아이템, 코스메틱)

### 2.4 시나리오: 진행 상황 저장

**전제조건**: 플레이어가 게임 종료

**흐름**:
1. 메타 진행 데이터 자동 저장
2. 다음 게임 시작 시 데이터 로드
3. 모든 업그레이드/해금 상태 유지

---

## 3. 기능 요구사항

### 3.1 메타 재화

| ID | 요구사항 | 수락 기준 |
|----|----------|-----------|
| FR-001 | Bone (뼈) | 적 처치, 상자에서 획득, 런 종료 시 유지 |
| FR-002 | Soul (영혼) | 보스 처치, 스테이지 클리어에서 획득 |
| FR-003 | 재화 표시 | 로비 및 던전 HUD에 재화량 표시 |
| FR-004 | 런 중 재화 | 런 도중 획득한 Bone은 임시 저장 |
| FR-005 | 사망 시 확정 | 사망/클리어 시 임시 재화가 영구 재화로 전환 |

### 3.2 영구 업그레이드

| ID | 요구사항 | 수락 기준 |
|----|----------|-----------|
| FR-010 | 체력 업그레이드 | 최대 체력 +5/10/15/20/25 (5단계) |
| FR-011 | 공격력 업그레이드 | 기본 공격력 +5%/10%/15%/20%/25% (5단계) |
| FR-012 | 방어력 업그레이드 | 받는 피해 -3%/6%/9%/12%/15% (5단계) |
| FR-013 | 이동속도 업그레이드 | 이동속도 +3%/6%/9%/12%/15% (5단계) |
| FR-014 | 골드 보너스 | 골드 획득량 +10%/20%/30%/40%/50% (5단계) |
| FR-015 | 경험치 보너스 | 경험치 획득량 +10%/20%/30% (3단계) |
| FR-016 | 시작 골드 | 런 시작 시 골드 50/100/150/200 (4단계) |
| FR-017 | 추가 대시 | 대시 횟수 +1 (1단계) |
| FR-018 | 부활 | 런당 1회 부활 (1단계, Soul 필요) |

### 3.3 해금 시스템

| ID | 요구사항 | 수락 기준 |
|----|----------|-----------|
| FR-020 | 폼 해금 | Soul로 새 폼 해금, 드롭 풀에 추가 |
| FR-021 | 아이템 해금 | Bone으로 새 아이템 해금, 드롭 풀에 추가 |
| FR-022 | 선행 조건 | 일부 해금은 다른 해금/업적 필요 |
| FR-023 | 해금 미리보기 | 잠긴 콘텐츠도 실루엣/힌트 표시 |
| FR-024 | 해금 진행도 | 전체 해금률 표시 |

### 3.4 업적 시스템

| ID | 요구사항 | 수락 기준 |
|----|----------|-----------|
| FR-030 | 진행 업적 | "적 100마리 처치", "스테이지 3 도달" 등 |
| FR-031 | 도전 업적 | "노데미지 보스 클리어", "10분 내 스테이지 1 클리어" 등 |
| FR-032 | 수집 업적 | "폼 5종 획득", "아이템 20종 획득" 등 |
| FR-033 | 업적 보상 | Bone, Soul, 특별 해금 |
| FR-034 | 업적 추적 | 진행 중인 업적 현황 표시 |
| FR-035 | 업적 목록 | 전체 업적 목록 및 달성률 |

### 3.5 로비 시스템

| ID | 요구사항 | 수락 기준 |
|----|----------|-----------|
| FR-040 | 업그레이드 NPC | 영구 업그레이드 구매 |
| FR-041 | 해금 NPC | 폼/아이템 해금 |
| FR-042 | 업적 게시판 | 업적 목록 및 보상 수령 |
| FR-043 | 던전 입구 | 새 런 시작 |
| FR-044 | 훈련장 | 해금된 폼/스킬 테스트 (선택적) |

### 3.6 저장/로드

| ID | 요구사항 | 수락 기준 |
|----|----------|-----------|
| FR-050 | 자동 저장 | 업그레이드/해금 즉시 저장 |
| FR-051 | 런 종료 저장 | 메타 재화 확정 시 저장 |
| FR-052 | 게임 시작 로드 | 게임 시작 시 진행 상황 로드 |
| FR-053 | 저장 슬롯 | 1개 저장 슬롯 (단일 진행) |

---

## 4. 비기능 요구사항

| ID | 요구사항 | 기준 |
|----|----------|------|
| NFR-001 | 저장 안정성 | 게임 크래시 시에도 마지막 저장 유지 |
| NFR-002 | 로드 시간 | 저장 데이터 로드 1초 이내 |
| NFR-003 | 밸런스 | 50시간 플레이 시 전체 해금의 70% 달성 가능 |

---

## 5. 성공 기준

| 기준 | 측정 방법 |
|------|-----------|
| 리텐션 향상 | 메타 진행 도입 후 재방문율 20% 증가 |
| 플레이 동기 | 플레이어의 80%가 "다음 업그레이드"를 목표로 설정 |
| 성장 체감 | 업그레이드 후 "더 강해진 느낌" 80% 이상 평가 |
| 밸런스 | 업그레이드 없이도 숙련 플레이어가 클리어 가능 |
| 저장 안정성 | 진행 데이터 손실 0건 |

---

## 6. 핵심 엔티티

### 6.1 MetaCurrency
- bone: Bone 보유량
- soul: Soul 보유량
- tempBone: 현재 런에서 획득한 임시 Bone

### 6.2 PermanentUpgrade
- upgradeId: 업그레이드 ID
- upgradeName: 이름
- description: 설명
- maxLevel: 최대 레벨
- costPerLevel: 레벨별 비용 배열
- effectPerLevel: 레벨별 효과 배열
- currencyType: 필요 재화 타입 (Bone/Soul)

### 6.3 PlayerMetaProgress (저장 데이터)
- bone: 영구 Bone 보유량
- soul: 영구 Soul 보유량
- upgradeLevels: Dictionary<업그레이드ID, 현재레벨>
- unlockedForms: 해금된 폼 ID 목록
- unlockedItems: 해금된 아이템 ID 목록
- completedAchievements: 완료된 업적 ID 목록
- achievementProgress: Dictionary<업적ID, 진행도>
- totalPlayTime: 총 플레이 시간
- totalRuns: 총 런 횟수
- highestStage: 최고 도달 스테이지

### 6.4 Achievement
- achievementId: 업적 ID
- name: 업적 이름
- description: 설명
- condition: 달성 조건
- targetValue: 목표값
- rewardType: 보상 타입
- rewardAmount: 보상량
- unlockId: 해금 콘텐츠 ID (있는 경우)

---

## 7. 가정 사항

1. 기존 SaveSystem (SaveManager, ISaveable)을 활용
2. 기존 CurrencySystem을 확장하여 메타 재화 관리
3. 로비 씬은 StartRoom을 확장/교체
4. PlayerStats에 영구 업그레이드 보너스 적용 가능

---

## 8. 의존성

- **SaveSystem**: 진행 데이터 저장/로드
- **CurrencySystem**: 재화 관리 (확장)
- **PlayerStats**: 업그레이드 효과 적용
- **InventorySystem**: 해금된 아이템 드롭 풀 관리
- **FormManager**: 해금된 폼 드롭 풀 관리
- **UI System**: 로비 UI, 업그레이드 트리 UI

---

## 9. 관련 문서

- 기존 SaveSystem: `Assets/_Project/Scripts/Core/SaveManager.cs`
- CurrencySystem: `Assets/_Project/Scripts/Gameplay/Economy/`
- MetaProgressionManager: `Assets/_Project/Scripts/Core/MetaProgressionManager.cs`

---

## 10. 업그레이드 비용 가이드라인 (밸런스 참고)

### Bone 업그레이드 (일반적)
| 레벨 | 1 | 2 | 3 | 4 | 5 |
|------|---|---|---|---|---|
| 비용 | 100 | 250 | 500 | 1000 | 2000 |

### Soul 업그레이드/해금 (희귀)
| 항목 | 비용 |
|------|------|
| 일반 폼 해금 | 50 Soul |
| 레어 폼 해금 | 150 Soul |
| 유니크 폼 해금 | 300 Soul |
| 부활 업그레이드 | 500 Soul |

### 재화 획득량 가이드
| 소스 | Bone | Soul |
|------|------|------|
| 일반 적 | 1-3 | - |
| 엘리트 적 | 5-10 | - |
| 상자 | 10-30 | - |
| 스테이지 보스 | 50 | 10 |
| 최종 보스 | 100 | 30 |
| 스테이지 클리어 보너스 | 스테이지 x 20 | 스테이지 x 5 |
