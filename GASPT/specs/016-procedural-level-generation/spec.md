# 절차적 레벨 생성 시스템

**기능 번호**: 016
**브랜치**: `016-procedural-level-generation`
**작성일**: 2025-11-29
**상태**: 명세 완료

---

## 1. 개요

### 1.1 기능 설명
플레이어가 매 런(Run)마다 새로운 던전 구조를 경험할 수 있도록 절차적으로 레벨을 생성하는 시스템입니다. Skul: The Hero Slayer와 유사하게 방(Room) 단위로 던전이 구성되며, 각 런마다 방의 배치, 적 구성, 보상이 달라집니다.

### 1.2 사용자 가치
- **리플레이 가치 향상**: 매번 다른 던전 구조로 신선한 경험 제공
- **전략적 선택**: 분기점에서 어떤 방으로 갈지 선택하는 재미
- **탐험 욕구 충족**: 미니맵을 통한 던전 구조 파악 및 탐험

### 1.3 범위
- **포함**: Room 생성, Room 연결, Room 타입, 미니맵 표시
- **제외**: Room 내부 Tilemap 자동 생성 (프리팹 기반 사용), 멀티플레이어

---

## 2. 사용자 시나리오

### 2.1 주요 시나리오: 던전 진입 및 탐험

**전제조건**: 플레이어가 StartRoom에서 던전 포탈에 진입

**흐름**:
1. 플레이어가 던전 포탈과 상호작용
2. 시스템이 해당 스테이지의 던전 구조 생성 (로딩 중)
3. 플레이어가 시작 방(Entry Room)에 스폰
4. 미니맵에 현재 방과 연결된 방들이 표시 (미방문은 ?로 표시)
5. 플레이어가 포탈을 통해 다음 방으로 이동
6. 방 클리어 시 해당 방에서 나가는 포탈 활성화
7. 보스 방 클리어 시 스테이지 완료

### 2.2 시나리오: 분기 선택

**전제조건**: 플레이어가 분기점이 있는 방에 도착

**흐름**:
1. 방에 2~3개의 포탈이 존재
2. 각 포탈 위에 다음 방 타입 아이콘 표시 (전투, 보물, 상점 등)
3. 플레이어가 원하는 포탈 선택
4. 선택하지 않은 경로는 해당 런에서 접근 불가

### 2.3 시나리오: 미니맵 확인

**전제조건**: 플레이어가 던전 탐험 중

**흐름**:
1. 화면 우측 상단에 미니맵 표시 (항상)
2. 방문한 방: 해당 타입 아이콘으로 표시
3. 미방문 인접 방: ? 아이콘으로 표시
4. 현재 위치: 강조 표시
5. Tab 키로 전체 맵 확대 보기 가능

---

## 3. 기능 요구사항

### 3.1 던전 구조 생성

| ID | 요구사항 | 수락 기준 |
|----|----------|-----------|
| FR-001 | 스테이지별 던전 구조 생성 | 1~5 스테이지 각각 고유한 구조 생성 가능 |
| FR-002 | 방 개수 설정 가능 | 스테이지별 최소/최대 방 개수 설정 |
| FR-003 | 필수 경로 보장 | 시작 → 보스까지 항상 도달 가능한 경로 존재 |
| FR-004 | 분기 생성 | 일부 방에서 2~3개의 선택지 제공 |
| FR-005 | Seed 기반 생성 | 동일 Seed로 동일한 던전 구조 재현 가능 |

### 3.2 Room 타입

| ID | 요구사항 | 수락 기준 |
|----|----------|-----------|
| FR-010 | Entry Room | 던전 시작 지점, 적 없음, 회복 가능 |
| FR-011 | Combat Room | 일반 적 스폰, 클리어 시 포탈 활성화 |
| FR-012 | Elite Room | 강화 적 스폰, 더 좋은 보상 |
| FR-013 | Treasure Room | 적 없음, 보물상자 1~3개 |
| FR-014 | Shop Room | NPC 상점, 아이템 구매 가능 |
| FR-015 | Rest Room | 회복, 스킬 강화 선택 |
| FR-016 | Boss Room | 보스 1체, 클리어 시 스테이지 완료 |
| FR-017 | Secret Room | 숨겨진 방, 특별 보상 (선택적) |

### 3.3 Room 연결

| ID | 요구사항 | 수락 기준 |
|----|----------|-----------|
| FR-020 | 포탈 자동 배치 | 방 프리팹의 Portal Point에 자동 생성 |
| FR-021 | 양방향 이동 | 이전 방으로 돌아가기 가능 |
| FR-022 | 클리어 조건 | Combat/Elite/Boss 방은 클리어 전 포탈 비활성화 |
| FR-023 | 다음 방 미리보기 | 포탈 위에 다음 방 타입 아이콘 표시 |

### 3.4 미니맵

| ID | 요구사항 | 수락 기준 |
|----|----------|-----------|
| FR-030 | 실시간 미니맵 | 화면 우측 상단 항상 표시 |
| FR-031 | 방문 상태 표시 | 방문/미방문/현재위치 구분 |
| FR-032 | 방 타입 아이콘 | 각 Room 타입별 고유 아이콘 |
| FR-033 | 전체 맵 보기 | Tab 키로 확대 맵 토글 |
| FR-034 | 연결선 표시 | 방 사이 연결 시각화 |

### 3.5 스테이지 구성

| ID | 요구사항 | 수락 기준 |
|----|----------|-----------|
| FR-040 | 스테이지 1 | 5~7개 방, 보스 1체 |
| FR-041 | 스테이지 2 | 7~9개 방, 더 강한 적 |
| FR-042 | 스테이지 3 | 9~11개 방, Elite 방 증가 |
| FR-043 | 스테이지 4 | 11~13개 방, 복잡한 분기 |
| FR-044 | 스테이지 5 | 13~15개 방, 최종 보스 |

---

## 4. 비기능 요구사항

| ID | 요구사항 | 기준 |
|----|----------|------|
| NFR-001 | 생성 시간 | 던전 구조 생성 2초 이내 |
| NFR-002 | 메모리 사용 | 현재 스테이지만 메모리에 유지 |
| NFR-003 | Room 로딩 | 다음 방 진입 시 1초 이내 로딩 |

---

## 5. 성공 기준

| 기준 | 측정 방법 |
|------|-----------|
| 매 런마다 다른 던전 구조 생성 | 100회 생성 시 90% 이상 고유 구조 |
| 플레이어가 막히지 않음 | 100회 생성 시 100% 보스 도달 가능 |
| 분기 선택 제공 | 평균 2회 이상의 분기 선택 기회 |
| 미니맵 가독성 | 사용자 테스트에서 80% 이상 "이해하기 쉬움" 평가 |
| 로딩 체감 | 로딩 화면 없이 자연스러운 전환 (페이드 효과) |

---

## 6. 핵심 엔티티

### 6.1 DungeonData
- stageNumber: 스테이지 번호 (1~5)
- seed: 생성 시드값
- rooms: Room 목록
- connections: Room 연결 정보
- entryRoomId: 시작 방 ID
- bossRoomId: 보스 방 ID

### 6.2 RoomData
- roomId: 고유 ID
- roomType: Room 타입 (Entry, Combat, Elite, Treasure, Shop, Rest, Boss)
- prefabName: 사용할 프리팹 이름
- position: 미니맵 상 위치
- isCleared: 클리어 여부
- isVisited: 방문 여부
- connectedRooms: 연결된 Room ID 목록

### 6.3 RoomConnection
- fromRoomId: 출발 Room ID
- toRoomId: 도착 Room ID
- portalPosition: 포탈 위치 인덱스

---

## 7. 가정 사항

1. Room 프리팹은 사전에 제작되어 있음 (Tilemap 포함)
2. 각 Room 프리팹에는 PortalPoint 위치가 지정되어 있음
3. EnemySpawnPoint는 Room 프리팹에 포함
4. Additive Scene Loading 구조 사용 (기존 시스템 활용)

---

## 8. 의존성

- **Portal System**: 기존 Portal 시스템 확장
- **Scene Management**: Additive Scene Loading
- **Enemy Spawn System**: 기존 스폰 시스템 활용
- **UI System**: MVP 패턴 기반 미니맵 UI

---

## 9. 관련 문서

- `docs/architecture/PROJECT_ARCHITECTURE.md`
- `docs/work-logs/LATEST.md`
- 기존 Room System: `Assets/_Project/Scripts/Gameplay/Level/Room/`
